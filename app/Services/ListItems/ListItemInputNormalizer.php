<?php

namespace App\Services\ListItems;

use App\Models\ListItem;

class ListItemInputNormalizer
{
    private const UNIT_ALIASES = [
        'С€С‚' => 'С€С‚',
        'С€С‚СѓРєР°' => 'С€С‚',
        'С€С‚СѓРєРё' => 'С€С‚',
        'С€С‚СѓРє' => 'С€С‚',
        'С€С‚СѓС‡РєР°' => 'С€С‚',
        'С€С‚СѓС‡РєРё' => 'С€С‚',
        'С€С‚СѓС‡РµРє' => 'С€С‚',
        'РµРґ' => 'С€С‚',
        'РµРґРёРЅРёС†Р°' => 'С€С‚',
        'РµРґРёРЅРёС†С‹' => 'С€С‚',
        'РµРґРёРЅРёС†' => 'С€С‚',
        'pc' => 'С€С‚',
        'pcs' => 'С€С‚',
        'piece' => 'С€С‚',
        'pieces' => 'С€С‚',
        'РєРі' => 'РєРі',
        'kg' => 'РєРі',
        'РєРёР»Рѕ' => 'РєРі',
        'РєРёР»РѕРіСЂР°РјРј' => 'РєРі',
        'РєРёР»РѕРіСЂР°РјРјР°' => 'РєРі',
        'РєРёР»РѕРіСЂР°РјРјРѕРІ' => 'РєРі',
        'Рі' => 'Рі',
        'РіСЂ' => 'Рі',
        'gram' => 'Рі',
        'grams' => 'Рі',
        'РіСЂР°РјРј' => 'Рі',
        'РіСЂР°РјРјР°' => 'Рі',
        'РіСЂР°РјРјРѕРІ' => 'Рі',
        'Р»' => 'Р»',
        'l' => 'Р»',
        'Р»РёС‚СЂ' => 'Р»',
        'Р»РёС‚СЂР°' => 'Р»',
        'Р»РёС‚СЂРѕРІ' => 'Р»',
        'РјР»' => 'РјР»',
        'ml' => 'РјР»',
        'РјРёР»Р»РёР»РёС‚СЂ' => 'РјР»',
        'РјРёР»Р»РёР»РёС‚СЂР°' => 'РјР»',
        'РјРёР»Р»РёР»РёС‚СЂРѕРІ' => 'РјР»',
        'СѓРї' => 'СѓРї',
        'СѓРїР°Рє' => 'СѓРї',
        'СѓРїР°РєРѕРІРєР°' => 'СѓРї',
        'СѓРїР°РєРѕРІРєРё' => 'СѓРї',
        'СѓРїР°РєРѕРІРѕРє' => 'СѓРї',
        'pack' => 'СѓРї',
        'packs' => 'СѓРї',
        'package' => 'СѓРї',
        'packages' => 'СѓРї',
        'pkg' => 'СѓРї',
        'РїР°С‡' => 'РїР°С‡',
        'РїР°С‡РєР°' => 'РїР°С‡',
        'РїР°С‡РєРё' => 'РїР°С‡',
        'РїР°С‡РµРє' => 'РїР°С‡',
        'РїР°Рє' => 'РїР°Рє',
        'РїР°РєРµС‚' => 'РїР°Рє',
        'РїР°РєРµС‚Р°' => 'РїР°Рє',
        'РїР°РєРµС‚РѕРІ' => 'РїР°Рє',
        'packet' => 'РїР°Рє',
        'packets' => 'РїР°Рє',
        'Р±СѓС‚' => 'Р±СѓС‚',
        'Р±СѓС‚С‹Р»РєР°' => 'Р±СѓС‚',
        'Р±СѓС‚С‹Р»РєРё' => 'Р±СѓС‚',
        'Р±СѓС‚С‹Р»РѕРє' => 'Р±СѓС‚',
        'bottle' => 'Р±СѓС‚',
        'bottles' => 'Р±СѓС‚',
        'Р±Р°РЅ' => 'Р±Р°РЅ',
        'Р±Р°РЅРєР°' => 'Р±Р°РЅ',
        'Р±Р°РЅРєРё' => 'Р±Р°РЅ',
        'Р±Р°РЅРѕРє' => 'Р±Р°РЅ',
        'jar' => 'Р±Р°РЅ',
        'jars' => 'Р±Р°РЅ',
        'РєРѕСЂ' => 'РєРѕСЂ',
        'РєРѕСЂРѕР±РєР°' => 'РєРѕСЂ',
        'РєРѕСЂРѕР±РєРё' => 'РєРѕСЂ',
        'РєРѕСЂРѕР±РѕРє' => 'РєРѕСЂ',
        'box' => 'РєРѕСЂ',
        'boxes' => 'РєРѕСЂ',
        'СЂСѓР»' => 'СЂСѓР»',
        'СЂСѓР»РѕРЅ' => 'СЂСѓР»',
        'СЂСѓР»РѕРЅР°' => 'СЂСѓР»',
        'СЂСѓР»РѕРЅРѕРІ' => 'СЂСѓР»',
        'roll' => 'СЂСѓР»',
        'rolls' => 'СЂСѓР»',
        'РґСЋР¶' => 'РґСЋР¶',
        'РґСЋР¶РёРЅР°' => 'РґСЋР¶',
        'РґСЋР¶РёРЅС‹' => 'РґСЋР¶',
        'РґСЋР¶РёРЅ' => 'РґСЋР¶',
        'dozen' => 'РґСЋР¶',
        'dozens' => 'РґСЋР¶',
        'dz' => 'РґСЋР¶',
        'РїРѕСЂС†' => 'РїРѕСЂС†',
        'РїРѕСЂС†РёСЏ' => 'РїРѕСЂС†',
        'РїРѕСЂС†РёРё' => 'РїРѕСЂС†',
        'РїРѕСЂС†РёР№' => 'РїРѕСЂС†',
        'portion' => 'РїРѕСЂС†',
        'portions' => 'РїРѕСЂС†',
    ];

    public function normalizeQuantity(mixed $value): ?float
    {
        if ($value === null || $value === '') {
            return null;
        }

        $quantity = (float) $value;
        if ($quantity <= 0) {
            return null;
        }

        return round($quantity, 2);
    }

    public function normalizePriority(mixed $value): ?string
    {
        if (! is_string($value)) {
            return null;
        }

        $priority = mb_strtolower(trim($value), 'UTF-8');

        return match ($priority) {
            ListItem::PRIORITY_URGENT, ListItem::PRIORITY_TODAY, ListItem::PRIORITY_LATER => $priority,
            default => null,
        };
    }

    public function normalizeUnit(mixed $value): ?string
    {
        if (! is_string($value)) {
            return null;
        }

        $unit = mb_strtolower(trim($value), 'UTF-8');
        $unit = str_replace('С‘', 'Рµ', $unit);
        $unit = preg_replace('/[.,;:]+$/u', '', $unit) ?? $unit;
        if ($unit === '') {
            return null;
        }

        $normalized = self::UNIT_ALIASES[$unit] ?? null;

        if ($normalized !== null) {
            return $normalized;
        }

        return mb_substr($unit, 0, 24);
    }
}
